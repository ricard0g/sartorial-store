{% comment %}
    Renders Facets (filtering)

    Accepts:
    - results: {Object} Collection or Search object
    - paginate: {Object} Pagination object

    Usage:
    {% render 'facets', results: collection, paginate: paginate %}
{% endcomment %}


{% liquid
    assign sort_by = results.sort_by | default: results.default_sort_by
    assign total_active_values = 0
    assign default_presentation = 'text'
    if results.url
        assign results_url = results.url
    else
        assign terms = results.terms | escape
        assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
    endif
%}

<div class="facets-container">
    <facet-filters-form class="facets__form">
        <form id="FacetFiltersForm">
            {% if results.terms %}
                <input type="hidden" name="q" value="{{ results.terms | escape }}">
                <input name="options[prefix]" type="hidden" value="last">
            {% endif %}

            <div id="FacetsWrapperDesktop" class="facets__wrapper">
                <div class="facets-header">
                    <div class="facet__filters-header">
                        {% unless results.filters == empty %}
                            <h2 class="facets__heading">Filter:</h2>
                        {% endunless %}
                        <facet-remove class="facet-filters__clear">
                            <a href="{{ results_url }}" class="facets__reset js-facet-remove">
                                <span>Remove All</span>
                            </a>
                        </facet-remove>
                    </div>
                    <div class="active-facets active-facets-desktop">
                        {% for filter in results.filters %}
                            {% for value in filter.active_values %}
                                <facet-remove class="active-facets__button-wrapper">
                                    <a href="{{ value.url_to_remove }}" class="active-facets__button-remove js-facet-remove">
                                        <span class="active-facets__button-inner">
                                            {{ filter.label | escape }}: {{ value.label | escape }}
                                            <span class="svg-wrapper">
                                                {{ 'close-icon.svg' | inline_asset_content }}
                                            </span>
                                        </span>
                                    </a>
                                </facet-remove>
                            {% endfor %}
                            {% if filter.type == 'price_range' %}
                                {% assign min = filter.min_value.value %}
                                {% assign max = filter.max_value.value %}
                                {% if min != null or max != null %}
                                    <facet-remove class="active-facets__button-wrapper">
                                        <a href="{{ filter.url_to_remove }}" class="active-facets__button-remove js-facet-remove">
                                            <span class="active-facets__button-inner">
                                                {{ min | default: 0 | money }} - {{ max | default: 0 | money }}
                                                <span class="svg-wrapper">
                                                    {{ 'close-icon.svg' | inline_asset_content }}
                                                </span>
                                            </span>
                                        </a>
                                    </facet-remove>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <script src="{{ 'show-more.js' | asset_url }}" defer></script>
            {% comment %} Fiters for vertical filters {% endcomment %}
            {% for filter in results.filters %}
                {% liquid
                    assign total_active_values = total_active_values | plus: filter.active_values.size
                    assign presentation = filter.presentation | default: default_presentation

                    if presentation == 'image'
                        assign show_more_number = 12
                        assign visual_layout_class = 'facets-layout facets-layout-grid facets-layout-grid__' | append: presentation
                    else
                        assign show_more_number = 10
                        assign visual_layout_class = 'facets-layout facets-layout-list facets-layout-list__' | append: presentation
                    endif
                %}

                {% case filter.type %}
                    {% when 'boolean', 'list' %}
                        <details
                            id="Details-{{ filter.label | escape }}-{{ forloop.index }}"
                            {% if forloop.index == 1 %}
                                open
                            {% endif %}
                            class="facet-details js-filter"
                        >
                            <summary class="facets__summary">
                                <div>
                                    <span>
                                        {{ filter.label | escape }}
                                        <span class="facets__selected">({{ filter.active_values.size }})</span>
                                    </span>
                                    {% if filter.operator == 'AND' %}
                                        <span class="facets__operator"> Match All </span>
                                    {% endif %}
                                    <span class="svg-wrapper">
                                        {{ 'icon-caret.svg' | inline_asset_content }}
                                    </span>
                                </div>
                            </summary>
                            <div class="facet-content facets__display">
                                <div class="facets__header">
                                    <span class="facets__selected">{{ filter.active_values.size }} selected</span>
                                    <a href="{{ filter.url_to_remove }}" class="facets__reset js-facet-remove">Reset</a>
                                </div>
                                <fieldset class="facets__list">
                                    <legend class="visually-hidden">{{ filter.label | escape }}</legend>
                                    <div class="facets-wrap">
                                        <ul class="facets__list {{ visual_layout_class }}" role="list">
                                            {% liquid
                                                assign sorted_values = filter.values
                                                # Keep the selected values grouped together when operator is AND, keeping in those that are active together before those that are inactive
                                                if filter.operator == 'AND'
                                                    assign active_filter_values = filter.values | where: 'active', true
                                                    assign inactive_filter_values = filter.values | where: 'active', false
                                                    assign sorted_values = active_filter_values | concat: inactive_filter_values
                                                endif
                                            %}
                                            {% for value in sorted_values %}
                                                {% liquid
                                                    assign input_id = 'Filter-' | append: filter.param_name | escape | append: '-' | append: forloop.index
                                                    assign disabled = false
                                                    if value.count == 0 and value.active == false
                                                        assign disabled = true
                                                    endif
                                                    
                                                    assign hidden_class = ''
                                                    if forloop.index > show_more_number
                                                        assign hidden_class = 'hidden facets__item'
                                                    endif
                                                %}
                                                {% capture label_class %}
                                                    facets__label facet-checkbox{% if disabled %} disabled{% endif %}{% if value.active %} active{% endif %}
                                                {% endcapture %}

                                                {% capture text_value %}
                                                    <span aria-hidden="true">
                                                    <span class="facet-value">{{ value.label | escape }}</span> <span class="facet-count">{{ value.count }}</span>
                                                    </span>
                                                    <span class="visually-hidden">
                                                        {{ value.label | escape }} (
                                                            {% if value.count == 1 %}
                                                                {{ value.count }} result
                                                            {% else %}
                                                                {{ value.count }} results
                                                            {% endif %})
                                                    </span>
                                                {% endcapture %}

                                                <li class="facets__item {{ hidden_class }}">
                                                    {% if presentation == 'swatch' %}
                                                        <div>
                                                            <div>
                                                                {% render 'swatch-input',
                                                                    input: input_id,
                                                                    type: checkbox,
                                                                    name: value.param_name,
                                                                    value: value.value,
                                                                    product_form_id: 'FacetFiltersForm',
                                                                    swatch: value.swatch,
                                                                    checked: value.active,
                                                                    disabled: disabled
                                                                %}
                                                            </div>
                                                            {{ text_value }}
                                                        </div>
                                                    {% else %}
                                                        <label for="{{ input_id }}" class="{{ label_class }}">
                                                            <input
                                                                type="checkbox"
                                                                name="{{ value.param_name }}"
                                                                value="{{ value.value }}"
                                                                id="{{ input_id }}"
                                                                class="custom-checkbox"
                                                                {% if value.active %}
                                                                    checked
                                                                {% endif %}
                                                                {% if disabled %}
                                                                    disabled
                                                                {% endif %}
                                                            >

                                                            {% if presentation == 'image' %}
                                                                <div class="facet-image-wrapper">
                                                                    {% if value.image %}
                                                                        {{
                                                                            value.image
                                                                            | image_url: width: 300
                                                                            | image_tag:
                                                                                class: 'facet-image',
                                                                                alt: value.alt
                                                                        }}
                                                                    {% endif %}
                                                                </div>
                                                            {% else %}
                                                                <div class="checkbox-container">
                                                                    <div class="checkbox-square">
                                                                        {{ 'square.svg' | inline_asset_content }}
                                                                    </div>
                                                                    <div class="checkbox-checkmark">
                                                                        {{ 'icon-checkmark.svg' | inline_asset_content }}
                                                                    </div>
                                                                </div>
                                                            {% endif %}
                                                            {{ text_value }}
                                                        </label>
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        {% if filter.values.size > show_more_number %}
                                            <show-more-button class="facets__show-more">
                                                <button id="Show-More-{{ forloop.index }}-{{ section.id }}" class="facets__show-more-button" type="button">
                                                    <span class="label-show-more">
                                                        <span aria-hidden="true">+ </span>Show more
                                                    </span>
                                                    <span class="label-show-less hidden">
                                                        <span aria-hidden="true">- </span>Show less
                                                    </span>
                                                </button>
                                            </show-more-button>
                                        {% endif %}
                                    </div>
                                </fieldset>
                            </div>
                        </details>
                    {% when 'price_range' %}
                        <details
                            id="Details-{{ filter.label | escape }}-{{ forloop.index }}"
                            {% if forloop.index == 1 %}
                                open
                            {% endif %}
                            class="facet-details js-filter"
                        >
                            <summary class="facets__summary">
                                <div>
                                    <span>{{ filter.label | escape }}</span>
                                    <span class="svg-wrapper">
                                        {{ 'icon-caret.svg' | inline_asset_content }}
                                    </span>
                                </div>
                            </summary>
                            <div id="Facet-{{ forloop.index }}-{{ section.id }}" class="facet-content facets__display">
                                <div class="facets__header">
                                    {% assign max_price_count = filter.range_max | money | strip_html | escape %}
                                    <span> The highest price is {{ max_price_count }} </span>
                                    <a href="{{ filter.url_to_remove }}" class="facets__reset js-facet-remove">Reset</a>
                                </div>
                                <price-range class="facets__price">
                                    {% render 'price-facet', filter: filter, id_prefix: 'Filter-' %}
                                </price-range>
                            </div>
                        </details>
                {% endcase %}
            {% endfor %}
        </form>
    </facet-filters-form>
    
    {% comment %} Mobile facet drawer {% endcomment %}
    {% comment %} <div class="mobile-facets__wrapper" id="FacetFiltersFormMobile">
        <form id="FacetFiltersFormMobile" class="mobile-facets">
            <div class="mobile-facets__inner">
                <div class="mobile-facets__header">
                    <div class="mobile-facets__heading">
                        <h2 class="mobile-facets__heading-text">Filter and sort</h2>
                        <button class="mobile-facets__close-button" type="button" aria-label="Close filters">
                            <svg viewBox="0 0 14 14" class="icon icon-close">
                                <path d="M14 1.41L12.59 0L7 5.59L1.41 0L0 1.41L5.59 7L0 12.59L1.41 14L7 8.41L12.59 14L14 12.59L8.41 7L14 1.41Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mobile-facets__main">
                    <div class="mobile-facets__sort">
                        <div class="mobile-facets__sort-wrapper">
                            <label for="SortByMobile" class="mobile-facets__label">Sort by:</label>
                            <div class="select">
                                <select name="sort_by" id="SortByMobile" class="mobile-facets__select">
                                    {% for option in results.sort_options %}
                                        <option value="{{ option.value | escape }}" {% if option.value == sort_by %}selected="selected"{% endif %}>
                                            {{ option.name | escape }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <span class="svg-wrapper">
                                    {{ 'icon-caret.svg' | inline_asset_content }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="mobile-facets__filters">
                        <h3 class="mobile-facets__label">Filter:</h3>
                        <div class="mobile-facets__filters-list">
                            {% for filter in results.filters %}
                                <details id="Details-Mobile-{{ forloop.index }}-{{ section.id }}" class="mobile-facets__details js-filter">
                                    <summary class="mobile-facets__summary">
                                        <div>
                                            <span>{{ filter.label | escape }}</span>
                                            <span class="mobile-facets__arrow">
                                                <svg viewBox="0 0 14 10" class="icon icon-arrow">
                                                    <path d="M1 5L7 9L13 5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                                </svg>
                                            </span>
                                        </div>
                                    </summary>
                                    <div id="mobile-{{ filter.label | escape }}-{{ forloop.index }}" class="mobile-facets__submenu">
                                        <button class="mobile-facets__close-button" type="button" aria-expanded="true" aria-controls="mobile-{{ filter.label | escape }}-{{ forloop.index }}">
                                            <span class="mobile-facets__close">{{ filter.label | escape }}</span>
                                            <svg viewBox="0 0 14 14" class="icon icon-close">
                                                <path d="M14 1.41L12.59 0L7 5.59L1.41 0L0 1.41L5.59 7L0 12.59L1.41 14L7 8.41L12.59 14L14 12.59L8.41 7L14 1.41Z" fill="currentColor"/>
                                            </svg>
                                        </button>
                                        <ul class="mobile-facets__list">
                                            {% for value in filter.values %}
                                                <li class="mobile-facets__item">
                                                    <label class="mobile-facets__label">
                                                        <input class="mobile-facets__checkbox" type="checkbox" name="{{ value.param_name }}" value="{{ value.value }}" {% if value.active %}checked{% endif %}{% if value.count == 0 and value.active == false %}disabled{% endif %}>
                                                        <span class="mobile-facets__highlight"></span>
                                                        <span>{{ value.label | escape }} ({{ value.count }})</span>
                                                    </label>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        <div class="mobile-facets__footer">
                                            <button class="mobile-facets__apply-button button" type="button">Apply</button>
                                        </div>
                                    </div>
                                </details>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div> {% endcomment %}

{% style %}
    .facets-container {
        padding: 20px;
        background-color: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
    }

    .facets-header {
        margin-bottom: 20px;
    }

    .facet-details {
        margin-bottom: 10px;
    }

    .facet-summary {
        cursor: pointer;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
    }

    .facet-content {
        padding: 10px;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        margin-top: 5px;
    }

    /* Custom checkbox styles */
    .custom-checkbox {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .checkbox-container {
        position: relative;
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 8px;
        vertical-align: middle;
    }

    .checkbox-square,
    .checkbox-checkmark {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .checkbox-square svg {
        width: 100%;
        height: 100%;
    }

    .checkbox-checkmark {
        display: none;
    }

    .checkbox-checkmark svg {
        width: 80%;
        height: 80%;
        margin: 10%;
    }

    .custom-checkbox:checked ~ .checkbox-container .checkbox-checkmark {
        display: block;
    }

    /* Make the label more clickable */
    .facets__label {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin-bottom: 8px;
    }

    .facets__label.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
{% endstyle %}
